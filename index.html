<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oven X - Rider Command</title>
    
    <!-- Maps and Communication -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --red: #8b0000; --orange: #f37021; --bg: #fff9f5; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; height: 100%; background: var(--bg); overflow: hidden; }
        
        header { background: var(--red); color: white; padding: 15px; text-align: center; font-weight: 900; border-bottom: 5px solid var(--orange); position: relative; z-index: 10; }
        header span { color: var(--orange); }

        /* UI Containers */
        .container { display: flex; flex-direction: column; height: 100%; }
        #rider-view, #admin-view { flex: 1; display: none; overflow-y: auto; }

        /* Rider UI */
        .card { background: white; margin: 20px; padding: 30px; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .warning { background: #fff3cd; color: #856404; padding: 15px; border-radius: 15px; font-size: 13px; margin-bottom: 20px; border: 1px solid #ffeeba; text-align: left; }
        input { width: 90%; padding: 15px; border-radius: 15px; border: 2px solid #ddd; margin-bottom: 20px; font-size: 18px; outline: none; }
        .btn { background: var(--orange); color: white; padding: 20px; border-radius: 50px; border: none; font-weight: 900; width: 100%; cursor: pointer; box-shadow: 0 5px 0 #b34e12; text-transform: uppercase; font-size: 18px; }
        .btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #b34e12; }
        
        #status-light { display: inline-block; width: 12px; height: 12px; background: #25D366; border-radius: 50%; margin-right: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* Admin Map */
        #map { height: 100%; width: 100%; }
        .rider-label { background: white; border: 2px solid var(--red); padding: 2px 8px; border-radius: 5px; font-weight: bold; color: var(--red); }

        #keepAliveVideo { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div class="container">
    <header id="top-header">OVEN X <span>TRACKER</span></header>

    <!-- RIDER SECTION -->
    <div id="rider-view">
        <div class="card" id="login-card">
            <div class="warning">
                <b>⚙️ ANDROID SETUP:</b><br>
                1. Long press Chrome icon > App Info<br>
                2. Battery > <b>Unrestricted</b><br>
                3. Keep this page open.
            </div>
            <h3>RIDER LOGIN</h3>
            <input type="text" id="riderName" placeholder="Enter Name">
            <button class="btn" onclick="startTracking()">Start Delivery</button>
        </div>

        <div class="card" id="active-card" style="display:none;">
            <h2 id="name-tag"></h2>
            <div style="font-size: 20px; font-weight: bold; color: #25D366;">
                <span id="status-light"></span> TRACKING LIVE
            </div>
            <p style="color: #666; margin-top: 20px;">You can now turn off your screen.<br>Put the phone in your pocket.</p>
            <button class="btn" style="background:#444; box-shadow:0 5px 0 #222; margin-top:30px;" onclick="location.reload()">Stop & Go Offline</button>
        </div>
    </div>

    <!-- ADMIN SECTION -->
    <div id="admin-view">
        <div id="map"></div>
    </div>
</div>

<!-- Silent Video Hack -->
<video id="keepAliveVideo" playsinline muted loop>
    <source src="https://raw.githubusercontent.com/anars/blank-audio/master/250-milliseconds-of-silence.mp3" type="audio/mp3">
</video>

<script>
    // --- SETTINGS ---
    const SECRET_TOPIC = 'ovenx_lahore_pindi_hq_track'; // KEEP THIS THE SAME FOR RIDER AND ADMIN
    const NTFY_URL = `https://ntfy.sh/${SECRET_TOPIC}`;

    // --- DETECT ROLE ---
    const params = new URLSearchParams(window.location.search);
    const isAdmin = params.get('admin') === 'true';

    if (isAdmin) {
        showAdmin();
    } else {
        showRider();
    }

    // --- RIDER FUNCTIONS ---
    function showRider() {
        document.getElementById('rider-view').style.display = 'block';
    }

    async function startTracking() {
        const name = document.getElementById('riderName').value.trim();
        if (!name) return alert("Please enter your name!");

        // Play silent video to keep Android Chrome alive in background
        const video = document.getElementById('keepAliveVideo');
        video.play();

        // WakeLock prevents the CPU from sleeping
        if ('wakeLock' in navigator) {
            try { await navigator.wakeLock.request('screen'); } catch (err) {}
        }

        document.getElementById('login-card').style.display = 'none';
        document.getElementById('active-card').style.display = 'block';
        document.getElementById('name-tag').innerText = "HI, " + name.toUpperCase();

        // Start GPS
        navigator.geolocation.watchPosition((pos) => {
            const data = {
                n: name,
                lt: pos.coords.latitude,
                lg: pos.coords.longitude,
                s: pos.coords.speed ? Math.round(pos.coords.speed * 3.6) : 0,
                t: Date.now()
            };

            fetch(NTFY_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            });
        }, (err) => {
            console.error("GPS Error", err);
        }, { enableHighAccuracy: true });
    }

    // --- ADMIN FUNCTIONS ---
    function showAdmin() {
        document.getElementById('admin-view').style.display = 'block';
        document.getElementById('top-header').innerHTML = "OVEN X <span>LIVE MAP</span>";
        
        // Initialize Map
        const map = L.map('map').setView([31.5204, 74.3587], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let markers = {};

        // Receive Data
        const source = new EventSource(`${NTFY_URL}/sse`);
        source.onmessage = (event) => {
            try {
                const raw = JSON.parse(event.data);
                const rider = JSON.parse(raw.message);
                
                const pos = [rider.lt, rider.lg];
                const info = `<b>${rider.n}</b><br>${rider.s} km/h`;

                if (markers[rider.n]) {
                    markers[rider.n].setLatLng(pos).setTooltipContent(info);
                } else {
                    markers[rider.n] = L.marker(pos).addTo(map)
                        .bindTooltip(info, {permanent: true, direction: 'top', className: 'rider-label'})
                        .openTooltip();
                }
            } catch (e) {}
        };
    }
</script>

</body>
</html>
