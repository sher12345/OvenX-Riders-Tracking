<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oven X - Live Tracking</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#8b0000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/7541/7541900.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/7541/7541900.png">
    
    <!-- Leaflet & Firebase -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { --red: #8b0000; --orange: #f37021; --dark: #1a1a1a; --white: #ffffff; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; height: 100%; width: 100%; background: #f4f4f4; overflow: hidden; }
        
        header { background: var(--red); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--orange); z-index: 5000; position: relative; }
        header h1 { margin: 0; font-size: 18px; letter-spacing: 1px; }

        .screen { display: none; height: calc(100vh - 65px); width: 100%; position: relative; overflow-y: auto; }
        .active { display: block; }

        .login-container { padding: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80%; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 15px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; transition: 0.3s; }
        .btn-main { background: var(--orange); color: white; box-shadow: 0 4px 0 #b34e12; }
        .btn-outline { background: transparent; border: 2px solid var(--orange); color: var(--orange); margin-top: 20px; }

        /* Download Banner */
        #download-option { 
            background: #fff; border: 2px solid var(--orange); border-radius: 15px; 
            padding: 15px; margin: 10px; text-align: center; display: block; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        #map { height: 100%; width: 100%; background: #e5e3df; }
        #sidebar { position: absolute; top: 10px; left: 10px; width: 220px; max-height: 50%; background: white; z-index: 1000; border-radius: 10px; padding: 10px; border-left: 5px solid var(--orange); box-shadow: 0 4px 15px rgba(0,0,0,0.2); overflow-y: auto; font-size: 13px; }
        .rider-row { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .online-dot { color: #2ecc71; }
        .status-box { padding: 20px; margin-top: 20px; border-radius: 15px; background: #e8f5e9; color: #2e7d32; font-weight: bold; border: 1px solid #2e7d32; }
    </style>
</head>
<body>

<header>
    <h1>OVEN <span style="color:var(--orange)">X</span> MULTAN</h1>
    <div id="sync-indicator" style="font-size:10px; background:#2ecc71; padding:4px 8px; border-radius:10px;">LIVE</div>
</header>

<!-- 1. Selection Screen -->
<div id="selection-screen" class="screen active">
    <div class="login-container">
        
        <!-- DOWNLOAD OPTION -->
        <div id="download-option">
            <p style="margin:0 0 10px 0; font-weight:bold; font-size: 14px;">üì≤ Use as App for better tracking</p>
            <button class="btn btn-main" id="installBtn" onclick="installApp()" style="margin:0; padding:10px;">DOWNLOAD OVEN X APP</button>
            <p id="ios-notice" style="display:none; font-size:11px; color:#666; margin-top:10px;">iPhone: Tap <img src="https://cdn-icons-png.flaticon.com/512/3024/3024593.png" width="15"> then "Add to Home Screen"</p>
        </div>

        <div class="card" style="margin-top:20px;">
            <img src="https://cdn-icons-png.flaticon.com/512/7541/7541900.png" width="60" alt="logo">
            <h2 style="color: var(--red); margin: 10px 0;">Logistics Portal</h2>
            <button class="btn btn-main" onclick="showScreen('rider-login-screen')">I AM A RIDER</button>
            <button class="btn btn-outline" onclick="showScreen('admin-login-screen')">ADMIN LOGIN</button>
        </div>
    </div>
</div>

<!-- 2. Rider Login Screen -->
<div id="rider-login-screen" class="screen">
    <div class="login-container">
        <div class="card">
            <h3>Rider Entry</h3>
            <input type="text" id="riderName" placeholder="Your Full Name">
            <button class="btn btn-main" onclick="startRiderShift()">START SHIFT</button>
            <button class="btn" style="background:none; color:grey;" onclick="showScreen('selection-screen')">Back</button>
        </div>
    </div>
</div>

<!-- 3. Admin Login Screen -->
<div id="admin-login-screen" class="screen">
    <div class="login-container">
        <div class="card">
            <h3>Admin Access</h3>
            <input type="password" id="adminPass" placeholder="Enter Password">
            <button class="btn btn-main" onclick="verifyAdmin()">LOGIN TO MAP</button>
            <button class="btn" style="background:none; color:grey;" onclick="showScreen('selection-screen')">Back</button>
        </div>
    </div>
</div>

<!-- 4. Rider Active Screen -->
<div id="rider-active-screen" class="screen">
    <div class="login-container">
        <div class="card">
            <h2 id="activeRiderName" style="color:var(--red); margin:0;"></h2>
            <div class="status-box">TRACKING ACTIVE</div>
            <p style="font-size: 12px; color: #666; margin-top: 15px;">Keep this window open or minimized.<br>Location is shared with HQ.</p>
            <button class="btn btn-outline" onclick="stopShift()" style="border-color: #888; color: #888;">END SHIFT</button>
        </div>
    </div>
</div>

<!-- 5. Admin Panel Screen -->
<div id="admin-panel-screen" class="screen">
    <div id="sidebar">
        <strong style="color:var(--red)">LIVE RIDERS</strong>
        <div id="rider-list" style="margin-top:10px;">Waiting for GPS...</div>
    </div>
    <div id="map"></div>
</div>

<audio id="stayAlive" loop playsinline><source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA== " type="audio/wav"></audio>

<script>
    // --- 1. PWA CONFIGURATION (Manifest & Service Worker) ---
    const manifest = {
        "name": "Oven X Tracking",
        "short_name": "OvenX",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#8b0000",
        "theme_color": "#8b0000",
        "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/7541/7541900.png", "sizes": "512x512", "type": "image/png" }]
    };
    const stringManifest = JSON.stringify(manifest);
    const blob = new Blob([stringManifest], {type: 'application/json'});
    const manifestURL = URL.createObjectURL(blob);
    document.querySelector('head').innerHTML += `<link rel="manifest" href="${manifestURL}">`;

    if ('serviceWorker' in navigator) {
        const swCode = `self.addEventListener('fetch', function(e) { e.respondWith(fetch(e.request)); });`;
        const swBlob = new Blob([swCode], {type: 'application/javascript'});
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl);
    }

    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installBtn').style.display = 'block';
    });

    // Detect iOS to show special instructions
    if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
        if (!window.navigator.standalone) {
            document.getElementById('ios-notice').style.display = 'block';
            document.getElementById('installBtn').style.display = 'none';
        }
    }

    function installApp() {
        if (!deferredPrompt) {
            alert("To download: Click the 3-dots in Chrome and select 'Install App' or 'Add to Home Screen'");
            return;
        }
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choice) => {
            if (choice.outcome === 'accepted') document.getElementById('download-option').style.display = 'none';
        });
    }

    // --- 2. APP LOGIC ---
    const firebaseConfig = { databaseURL: "https://ovenx-tracking-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const SHOP_LOCATION = [30.216949, 71.470271]; 
    let map, markers = {}, watchID = null;

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        if(screenId === 'admin-panel-screen') initMap();
    }

    function verifyAdmin() {
        if(document.getElementById('adminPass').value === "asdasd@123") showScreen('admin-panel-screen');
        else alert("Incorrect Password");
    }

    function initMap() {
        if (map) return;
        map = L.map('map', { zoomControl: false }).setView(SHOP_LOCATION, 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker(SHOP_LOCATION).addTo(map).bindTooltip("HQ", { permanent: true });

        db.ref('riders').on('value', (snap) => {
            const data = snap.val();
            const listDiv = document.getElementById('rider-list');
            listDiv.innerHTML = '';
            for (let id in data) {
                const r = data[id];
                if ((Date.now() - r.lastSeen) < 60000) {
                    const label = `<b>${r.name}</b><br>${r.speed} km/h`;
                    if (markers[id]) markers[id].setLatLng([r.lat, r.lng]).setTooltipContent(label);
                    else markers[id] = L.marker([r.lat, r.lng]).addTo(map).bindTooltip(label, { permanent: true });
                    listDiv.innerHTML += `<div class="rider-row"><span>‚óè ${r.name}</span> <b>${r.speed}km/h</b></div>`;
                } else if (markers[id]) { map.removeLayer(markers[id]); delete markers[id]; }
            }
        });
    }

    function startRiderShift() {
        const name = document.getElementById('riderName').value.trim();
        if(!name) return alert("Enter name");
        document.getElementById('activeRiderName').innerText = name;
        document.getElementById('stayAlive').play();
        showScreen('rider-active-screen');
        const riderID = name.replace(/\s+/g, '_').toLowerCase();

        watchID = navigator.geolocation.watchPosition((pos) => {
            db.ref('riders/' + riderID).set({
                name: name, lat: pos.coords.latitude, lng: pos.coords.longitude,
                speed: Math.round((pos.coords.speed || 0) * 3.6),
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
        }, null, { enableHighAccuracy: true });
    }

    function stopShift() {
        if(watchID) navigator.geolocation.clearWatch(watchID);
        location.reload(); 
    }
</script>
</body>
</html>
