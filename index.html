<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oven X Command & Dispatch</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { --red: #8b0000; --orange: #f37021; --white: #ffffff; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; height: 100%; width: 100%; background: #f0f0f0; overflow: hidden; }
        header { background: var(--red); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--orange); z-index: 5000; }

        #admin-panel, #rider-app { display: none; height: calc(100vh - 55px); width: 100%; position: relative; }
        
        /* Rider UI */
        #rider-app { background: white; padding: 20px; box-sizing: border-box; text-align: center; overflow-y: auto; }
        .card { background: #fff; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid #eee; margin-bottom: 20px; }
        .btn-main { background: var(--orange); color: white; padding: 18px; border-radius: 50px; border: none; font-weight: 900; width: 100%; cursor: pointer; font-size: 16px; box-shadow: 0 5px 0 #b34e12; margin-top: 15px; }
        .btn-download { background: #2ecc71; color: white; padding: 12px; border-radius: 10px; border: none; width: 100%; font-weight: 900; display: none; margin-bottom: 15px; }
        input { width: 100%; padding: 15px; border-radius: 10px; border: 1px solid #ddd; text-align: center; font-size: 18px; margin-top: 20px; }

        /* Admin UI */
        #map { height: 100%; width: 100%; }
        #sidebar { position: absolute; top: 10px; left: 10px; width: 240px; max-height: 60%; background: rgba(255,255,255,0.95); z-index: 1000; border-radius: 15px; padding: 15px; border: 2px solid var(--orange); overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .rider-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }
        .rider-item b { color: var(--red); }
        .map-tools { position: absolute; bottom: 30px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .tool-btn { width: 50px; height: 50px; border-radius: 12px; background: white; border: 1px solid var(--orange); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        /* Smooth Animation */
        .leaflet-marker-icon { transition: transform 0.8s linear !important; }
        .rider-tooltip { background: var(--orange); color: white; border: 2px solid white; border-radius: 8px; padding: 5px 10px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<div id="main-wrapper" style="height:100vh; display:flex; flex-direction:column;">
    <header>
        <h1 style="margin:0; font-size: 18px;">OVEN <span style="color:var(--orange)">X</span> HQ</h1>
        <div id="status-tag" style="font-size:11px; font-weight:900;">PERSISTENT CLOUD</div>
    </header>

    <div id="rider-app">
        <button id="installBtn" class="btn-download" onclick="installPWA()">‚¨áÔ∏è DOWNLOAD OVEN X APP</button>
        
        <div class="card" id="login-screen">
            <h2 style="color:var(--red); margin:0;">Rider Login</h2>
            <p style="color:#777; font-size:13px;">Gulgasht Block A Dispatch</p>
            <input type="text" id="riderName" placeholder="Enter Full Name">
            <button class="btn-main" onclick="startShift()">START SHIFT</button>
        </div>

        <div class="card" id="active-screen" style="display:none;">
            <h2 id="display-name" style="color:var(--red); margin:0;"></h2>
            <div style="color:#2e7d32; font-weight:bold; margin:20px 0;">‚óè LIVE & PERSISTENT</div>
            <p style="font-size: 12px; color: #666;">Signals Sent: <span id="sig-count">0</span></p>
            <button onclick="endShift()" style="margin-top:20px; background:none; border:none; color:#bbb; text-decoration:underline; font-size: 12px;">End Shift Early</button>
        </div>
    </div>

    <div id="admin-panel">
        <div id="sidebar">
            <h4 style="margin:0 0 10px 0; color:var(--red); border-bottom: 2px solid var(--orange);">LIVE FLEET</h4>
            <div id="rider-list">Waiting for signals...</div>
        </div>
        <div id="map"></div>
        <div class="map-tools">
            <button class="tool-btn" onclick="focusShop()">üè†</button>
            <button class="tool-btn" onclick="focusAll()">üö¥</button>
        </div>
    </div>
</div>

<audio id="stayAlive" loop playsinline><source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA== " type="audio/wav"></audio>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = { databaseURL: "https://ovenx-tracking-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const SHOP = [30.216949, 71.470271];
    let map, markers = {}, fleet = {}, sigs = 0;

    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('admin') === 'true') {
            document.getElementById('admin-panel').style.display = 'block';
            initAdminMap();
        } else {
            document.getElementById('rider-app').style.display = 'block';
            if(localStorage.getItem('ovenx_rider')) {
                document.getElementById('riderName').value = localStorage.getItem('ovenx_rider');
            }
        }
    };

    // --- RIDER LOGIC ---
    function startShift() {
        const name = document.getElementById('riderName').value.trim().replace(/\s+/g, '_');
        if(!name) return alert("Enter Name");
        
        localStorage.setItem('ovenx_rider', name);
        document.getElementById('stayAlive').play();
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('active-screen').style.display = 'block';
        document.getElementById('display-name').innerText = name.replace(/_/g, ' ');

        navigator.geolocation.watchPosition((pos) => {
            const data = {
                lt: pos.coords.latitude,
                lg: pos.coords.longitude,
                s: Math.round((pos.coords.speed || 0) * 3.6),
                lastSeen: Date.now(),
                status: 'online'
            };
            db.ref('riders/' + name).set(data).then(() => {
                sigs++;
                document.getElementById('sig-count').innerText = sigs;
            });
        }, null, { enableHighAccuracy: true });
    }

    function endShift() {
        if(confirm("End shift?")) {
            const name = localStorage.getItem('ovenx_rider');
            db.ref('riders/' + name + '/status').set('offline');
            localStorage.removeItem('ovenx_rider');
            location.reload();
        }
    }

    // --- ADMIN PERSISTENT LOGIC ---
    function initAdminMap() {
        map = L.map('map', { zoomControl: false }).setView(SHOP, 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker(SHOP).addTo(map).bindTooltip("HQ - BLOCK A", { permanent: true, direction: 'bottom' });

        // This pulls and updates riders instantly even after a refresh
        db.ref('riders').on('value', (snapshot) => {
            const data = snapshot.val();
            const listContainer = document.getElementById('rider-list');
            listContainer.innerHTML = '';

            for (let name in data) {
                const r = data[name];
                const isOffline = (Date.now() - r.lastSeen > 180000) || r.status === 'offline';
                const label = `<b>${name.replace(/_/g, ' ')}</b><br>${isOffline ? 'OFFLINE' : r.s + ' km/h'}`;
                
                if (markers[name]) {
                    markers[name].setLatLng([r.lt, r.lg]).setTooltipContent(label);
                } else {
                    markers[name] = L.marker([r.lt, r.lg]).addTo(map).bindTooltip(label, { permanent: true, direction: 'top', className: 'rider-tooltip' });
                }

                markers[name].setOpacity(isOffline ? 0.4 : 1);

                const div = document.createElement('div');
                div.className = 'rider-item';
                div.innerHTML = `<b>${name.replace(/_/g, ' ')}</b>: ${isOffline ? 'Idle' : r.s + ' km/h'}`;
                listContainer.appendChild(div);
            }
        });
        setTimeout(() => map.invalidateSize(), 500);
    }

    function focusShop() { map.flyTo(SHOP, 18); }
    function focusAll() {
        const group = new L.featureGroup(Object.values(markers));
        if (group.getLayers().length > 0) map.fitBounds(group.getBounds().pad(0.5));
    }

    // PWA Install Logic
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installBtn').style.display = 'block';
    });
    function installPWA() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(() => { deferredPrompt = null; document.getElementById('installBtn').style.display = 'none'; });
        }
    }
</script>
</body>
</html>
