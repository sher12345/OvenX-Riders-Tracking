<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OvenX Local Tracker</title>
    
    <!-- PWA / Offline App Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#8b0000">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/7541/7541900.png">
    
    <!-- External Maps & Database (Cached by Service Worker) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { --red: #8b0000; --orange: #f37021; --white: #ffffff; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; height: 100%; width: 100%; background: #1a1a1a; color: white; overflow: hidden; }
        
        header { background: var(--red); padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--orange); }
        
        .screen { display: none; height: calc(100vh - 65px); width: 100%; position: relative; }
        .active { display: flex; flex-direction: column; align-items: center; justify-content: center; }

        .card { background: #fff; color: #333; padding: 30px; border-radius: 25px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 15px; margin: 15px 0; border-radius: 10px; border: 2px solid #ddd; font-size: 18px; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 18px; border-radius: 50px; border: none; font-weight: 900; font-size: 16px; cursor: pointer; text-transform: uppercase; }
        .btn-start { background: var(--orange); color: white; box-shadow: 0 5px 0 #b34e12; }
        .btn-admin { background: transparent; color: var(--orange); border: 2px solid var(--orange); margin-top: 20px; }

        #map { height: 100%; width: 100%; background: #222; }
        .offline-tag { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px; }
        
        /* Admin Sidebar */
        #admin-info { position: absolute; top: 10px; left: 10px; z-index: 1000; background: rgba(255,255,255,0.9); color: #000; padding: 10px; border-radius: 10px; width: 180px; font-size: 12px; pointer-events: none; }
    </style>
</head>
<body>

<header>
    <h2 style="margin:0; font-size: 20px;">OVEN <span style="color:var(--orange)">X</span></h2>
    <div id="net-status" class="offline-tag">OFFLINE MODE</div>
</header>

<!-- 1. Selection -->
<div id="screen-start" class="screen active">
    <div class="card">
        <h2 style="color:var(--red); margin:0;">Multan Branch</h2>
        <p style="color:#666; font-size: 12px;">Shift Tracking System</p>
        <input type="text" id="riderName" placeholder="Rider Name">
        <button class="btn btn-start" onclick="riderStart()">Start Shift</button>
        <button class="btn btn-admin" onclick="showAdminLogin()">Admin Panel</button>
    </div>
</div>

<!-- 2. Admin Login -->
<div id="screen-admin-login" class="screen">
    <div class="card">
        <h3>Admin Password</h3>
        <input type="password" id="adminPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        <button class="btn btn-start" onclick="adminAuth()">Login</button>
        <p onclick="location.reload()" style="color:#666; margin-top:15px; cursor:pointer;">Back</p>
    </div>
</div>

<!-- 3. Rider Active -->
<div id="screen-rider-active" class="screen">
    <div class="card" style="background: #f9f9f9;">
        <h1 id="activeName" style="color:var(--red); margin:0;"></h1>
        <div style="margin: 20px 0; font-size: 50px;">ðŸ›µ</div>
        <p style="font-weight:bold; color: #2ecc71;">TRACKING ACTIVE</p>
        <p style="font-size:12px; color:#777;">You can turn off internet now.<br>Data is being saved to phone memory.</p>
        <button class="btn" style="background:#eee; color:#666;" onclick="location.reload()">End Shift</button>
    </div>
</div>

<!-- 4. Admin Map -->
<div id="screen-admin-map" class="screen">
    <div id="admin-info">
        <b>Live Fleet</b><hr>
        <div id="rider-list">Waiting...</div>
    </div>
    <div id="map"></div>
</div>

<script>
    // --- DATABASE CONFIG ---
    const firebaseConfig = { databaseURL: "https://ovenx-tracking-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const SHOP = [30.216949, 71.470271]; // OvenX Multan
    let map, markers = {};

    // --- SERVICE WORKER (Makes app work without internet) ---
    const swCode = `
        self.addEventListener('install', e => self.skipWaiting());
        self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => caches.match(e.request))));
    `;
    const swBlob = new Blob([swCode], {type: 'application/javascript'});
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register(URL.createObjectURL(swBlob)); }

    // --- NAVIGATION ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function showAdminLogin() { showScreen('screen-admin-login'); }

    // --- RIDER LOGIC (OFFLINE FIRST) ---
    function riderStart() {
        const name = document.getElementById('riderName').value.trim();
        if(!name) return alert("Enter Name");
        
        document.getElementById('activeName').innerText = name;
        showScreen('screen-rider-active');

        // Record location even if offline
        navigator.geolocation.watchPosition(pos => {
            const riderData = {
                name: name,
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                t: Date.now()
            };

            // 1. Save to local phone memory (Offline Storage)
            let logs = JSON.parse(localStorage.getItem('trip_logs') || "[]");
            logs.push(riderData);
            localStorage.setItem('trip_logs', JSON.stringify(logs));

            // 2. Try to sync to Admin if internet exists
            if (navigator.onLine) {
                // Upload current location
                db.ref('riders/' + name.replace(/\s/g,'_')).set(riderData);
                
                // Upload all missed offline data
                if (logs.length > 0) {
                    logs.forEach(log => db.ref('history/' + name.replace(/\s/g,'_')).push(log));
                    localStorage.setItem('trip_logs', "[]"); // Clear memory after sync
                }
            }
        }, null, { enableHighAccuracy: true });
    }

    // --- ADMIN LOGIC ---
    function adminAuth() {
        if(document.getElementById('adminPass').value === 'asdasd@123') {
            showScreen('screen-admin-map');
            initMap();
        } else {
            alert("Wrong Password");
        }
    }

    function initMap() {
        if(map) return;
        map = L.map('map', { zoomControl: false }).setView(SHOP, 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        // Mark Shop
        L.marker(SHOP).addTo(map).bindTooltip("OvenX Multan HQ", {permanent:true});

        db.ref('riders').on('value', snap => {
            const data = snap.val();
            const list = document.getElementById('rider-list');
            list.innerHTML = '';

            for(let id in data) {
                const r = data[id];
                const active = (Date.now() - r.t) < 120000; // Active in last 2 mins

                if(active) {
                    if(markers[id]) markers[id].setLatLng([r.lat, r.lng]);
                    else markers[id] = L.marker([r.lat, r.lng]).addTo(map).bindTooltip(r.name, {permanent:true});
                    list.innerHTML += `<div>ðŸŸ¢ ${r.name}</div>`;
                } else {
                    if(markers[id]) map.removeLayer(markers[id]);
                    delete markers[id];
                    list.innerHTML += `<div style="color:gray">âšª ${r.name} (Idle)</div>`;
                }
            }
        });
    }

    // --- NETWORK MONITOR ---
    window.addEventListener('online',  () => {
        document.getElementById('net-status').innerText = "LIVE SYNC ON";
        document.getElementById('net-status').style.background = "#2ecc71";
    });
    window.addEventListener('offline', () => {
        document.getElementById('net-status').innerText = "OFFLINE MODE";
        document.getElementById('net-status').style.background = "#e74c3c";
    });
</script>

</body>
</html>
