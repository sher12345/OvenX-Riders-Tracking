<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oven X Command & Dispatch</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { --red: #8b0000; --orange: #f37021; --white: #ffffff; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; height: 100%; width: 100%; background: #f0f0f0; overflow: hidden; }
        header { background: var(--red); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--orange); z-index: 5000; }

        #admin-panel, #rider-app { display: none; height: calc(100vh - 55px); width: 100%; position: relative; }
        
        /* Rider UI */
        #rider-app { background: white; padding: 20px; box-sizing: border-box; text-align: center; overflow-y: auto; }
        .card { background: #fff; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid #eee; margin-bottom: 20px; }
        .btn-main { background: var(--orange); color: white; padding: 18px; border-radius: 50px; border: none; font-weight: 900; width: 100%; cursor: pointer; font-size: 16px; box-shadow: 0 5px 0 #b34e12; margin-top: 15px; }
        .btn-download { background: #2ecc71; color: white; padding: 15px; border-radius: 15px; border: none; width: 100%; font-weight: 900; margin-bottom: 20px; cursor: pointer; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* Admin UI */
        #map { height: 100%; width: 100%; }
        #sidebar { position: absolute; top: 10px; left: 10px; width: 260px; max-height: 60%; background: rgba(255,255,255,0.95); z-index: 1000; border-radius: 15px; padding: 15px; border: 2px solid var(--orange); overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .rider-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; position: relative; }
        .reconnecting { color: #d9534f; font-weight: bold; font-size: 10px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } }
        
        .leaflet-marker-icon { transition: transform 0.8s linear !important; }
        .rider-tooltip { background: var(--orange); color: white; border: 2px solid white; border-radius: 8px; padding: 5px 10px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<div id="main-wrapper" style="height:100vh; display:flex; flex-direction:column;">
    <header>
        <h1 style="margin:0; font-size: 18px;">OVEN <span style="color:var(--orange)">X</span> DISPATCH</h1>
        <div id="connection-status" style="font-size:10px; font-weight:900; background:#2ecc71; padding:4px 10px; border-radius:20px;">SYSTEM ONLINE</div>
    </header>

    <div id="rider-app">
        <button id="installBtn" class="btn-download" style="display:none;" onclick="installPWA()">üì≤ DOWNLOAD OVEN X APP</button>
        
        <div class="card" id="login-screen">
            <h2 style="color:var(--red); margin:0;">Rider Portal</h2>
            <p style="color:#777; font-size:13px;">Gulgasht Block A HQ</p>
            <input type="text" id="riderName" placeholder="Full Name" style="width:100%; padding:15px; border-radius:10px; border:1px solid #ddd; text-align:center; font-size:18px; margin-top:20px;">
            <button class="btn-main" onclick="startShift()">START SHIFT</button>
        </div>

        <div class="card" id="active-screen" style="display:none;">
            <h2 id="display-name" style="color:var(--red); margin:0;"></h2>
            <div id="rider-status-dot" style="color:#2e7d32; font-weight:bold; margin:20px 0;">‚óè TRACKING ACTIVE</div>
            <p style="font-size: 11px; color: #666;">Signals Syncing: <span id="sig-count">0</span></p>
            <button onclick="endShift()" style="margin-top:20px; background:none; border:none; color:#bbb; text-decoration:underline; font-size: 12px;">End Shift Early</button>
        </div>
    </div>

    <div id="admin-panel">
        <div id="sidebar">
            <h4 style="margin:0 0 10px 0; color:var(--red); border-bottom: 2px solid var(--orange);">FLEET STATUS</h4>
            <div id="rider-list">No riders active.</div>
        </div>
        <div id="map"></div>
    </div>
</div>

<audio id="stayAlive" loop playsinline><source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA== " type="audio/wav"></audio>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = { databaseURL: "https://ovenx-tracking-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const SHOP = [30.216949, 71.470271];
    let map, markers = {}, sigs = 0;

    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('admin') === 'true') {
            document.getElementById('admin-panel').style.display = 'block';
            initAdminMap();
        } else {
            document.getElementById('rider-app').style.display = 'block';
            if(localStorage.getItem('ovenx_rider')) {
                document.getElementById('riderName').value = localStorage.getItem('ovenx_rider');
            }
        }
    };

    // --- RIDER LOGIC (OFFLINE RESILIENT) ---
    function startShift() {
        const name = document.getElementById('riderName').value.trim().replace(/\s+/g, '_');
        if(!name) return alert("Enter Name");
        
        localStorage.setItem('ovenx_rider', name);
        document.getElementById('stayAlive').play();
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('active-screen').style.display = 'block';
        document.getElementById('display-name').innerText = name.replace(/_/g, ' ');

        // Monitor Connection Quality
        db.ref('.info/connected').on('value', (snap) => {
            const dot = document.getElementById('rider-status-dot');
            if (snap.val() === true) {
                dot.innerText = "‚óè TRACKING ACTIVE";
                dot.style.color = "#2e7d32";
            } else {
                dot.innerText = "‚óè WEAK SIGNAL - QUEUING...";
                dot.style.color = "#d9534f";
            }
        });

        navigator.geolocation.watchPosition((pos) => {
            const data = {
                lt: pos.coords.latitude,
                lg: pos.coords.longitude,
                s: Math.round((pos.coords.speed || 0) * 3.6),
                lastSeen: firebase.database.ServerValue.TIMESTAMP,
                status: 'online'
            };
            
            // OnDisconnect hook - Mark offline automatically if internet cut
            db.ref('riders/' + name).onDisconnect().update({ status: 'offline' });
            
            db.ref('riders/' + name).set(data).then(() => {
                sigs++;
                document.getElementById('sig-count').innerText = sigs;
            });
        }, null, { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 });
    }

    function endShift() {
        if(confirm("End shift?")) {
            const name = localStorage.getItem('ovenx_rider');
            db.ref('riders/' + name + '/status').set('offline');
            localStorage.removeItem('ovenx_rider');
            location.reload();
        }
    }

    // --- ADMIN LOGIC (WITH RECONNECTING ALERTS) ---
    function initAdminMap() {
        map = L.map('map', { zoomControl: false }).setView(SHOP, 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker(SHOP).addTo(map).bindTooltip("HQ - BLOCK A", { permanent: true, direction: 'bottom' });

        db.ref('riders').on('value', (snapshot) => {
            const data = snapshot.val();
            const listContainer = document.getElementById('rider-list');
            listContainer.innerHTML = '';
            const now = Date.now();

            for (let name in data) {
                const r = data[name];
                const timeDiff = now - r.lastSeen;
                
                // If no update for 60 seconds, show reconnecting alert
                const isReconnecting = timeDiff > 60000 && r.status === 'online';
                const isOffline = r.status === 'offline' || timeDiff > 300000;

                const label = `<b>${name.replace(/_/g, ' ')}</b><br>${isOffline ? 'Offline' : r.s + ' km/h'}`;
                
                if (markers[name]) {
                    markers[name].setLatLng([r.lt, r.lg]).setTooltipContent(label);
                } else {
                    markers[name] = L.marker([r.lt, r.lg]).addTo(map).bindTooltip(label, { permanent: true, direction: 'top', className: 'rider-tooltip' });
                }

                markers[name].setOpacity(isOffline ? 0.3 : (isReconnecting ? 0.6 : 1));

                const div = document.createElement('div');
                div.className = 'rider-item';
                div.innerHTML = `
                    <b>${name.replace(/_/g, ' ')}</b>: ${isOffline ? 'Offline' : r.s + ' km/h'}
                    ${isReconnecting ? '<br><span class="reconnecting">‚ö†Ô∏è RECONNECTING (WEAK INTERNET)</span>' : ''}
                `;
                listContainer.appendChild(div);
            }
        });
    }

    // --- PWA INSTALLATION LOGIC ---
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installBtn').style.display = 'block';
    });
    function installPWA() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(() => { deferredPrompt = null; document.getElementById('installBtn').style.display = 'none'; });
        }
    }
</script>
</body>
</html>
