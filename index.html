<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oven X - Live Tracking</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#8b0000">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/7541/7541900.png">
    
    <!-- Leaflet & Firebase -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { --red: #8b0000; --orange: #f37021; --dark: #1a1a1a; --white: #ffffff; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; height: 100%; width: 100%; background: #f4f4f4; overflow: hidden; }
        
        /* Header */
        header { background: var(--red); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--orange); z-index: 5000; position: relative; }
        header h1 { margin: 0; font-size: 18px; letter-spacing: 1px; }

        /* Screens */
        .screen { display: none; height: calc(100vh - 65px); width: 100%; position: relative; overflow-y: auto; }
        .active { display: block; }

        /* Login UI */
        .login-container { padding: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80%; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 15px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; transition: 0.3s; }
        .btn-main { background: var(--orange); color: white; box-shadow: 0 4px 0 #b34e12; }
        .btn-main:active { transform: translateY(3px); box-shadow: 0 1px 0 #b34e12; }
        .btn-outline { background: transparent; border: 2px solid var(--orange); color: var(--orange); margin-top: 20px; }

        /* Admin UI */
        #map { height: 100%; width: 100%; background: #e5e3df; }
        #sidebar { position: absolute; top: 10px; left: 10px; width: 220px; max-height: 50%; background: white; z-index: 1000; border-radius: 10px; padding: 10px; border-left: 5px solid var(--orange); box-shadow: 0 4px 15px rgba(0,0,0,0.2); overflow-y: auto; font-size: 13px; }
        .rider-row { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .online-dot { color: #2ecc71; }

        /* Rider UI */
        .status-box { padding: 20px; margin-top: 20px; border-radius: 15px; background: #e8f5e9; color: #2e7d32; font-weight: bold; border: 1px solid #2e7d32; }
        .pulse { animation: shadow-pulse 2s infinite; }
        @keyframes shadow-pulse { 0% { box-shadow: 0 0 0 0px rgba(46, 125, 50, 0.4); } 100% { box-shadow: 0 0 0 20px rgba(46, 125, 50, 0); } }

        /* PWA Install Button */
        #installBanner { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: none; }
    </style>
</head>
<body>

<header>
    <h1>OVEN <span style="color:var(--orange)">X</span> MULTAN</h1>
    <div id="sync-indicator" style="font-size:10px; background:#2ecc71; padding:4px 8px; border-radius:10px;">LIVE</div>
</header>

<!-- PWA Install Button -->
<div id="installBanner">
    <button class="btn btn-main" onclick="installPWA()" style="padding: 10px 20px;">üì≤ INSTALL APP</button>
</div>

<!-- 1. Selection Screen -->
<div id="selection-screen" class="screen active">
    <div class="login-container">
        <img src="https://cdn-icons-png.flaticon.com/512/7541/7541900.png" width="80" alt="logo">
        <h2 style="color: var(--red);">Logistics Portal</h2>
        <button class="btn btn-main" onclick="showScreen('rider-login-screen')">I AM A RIDER</button>
        <button class="btn btn-outline" onclick="showScreen('admin-login-screen')">ADMIN LOGIN</button>
    </div>
</div>

<!-- 2. Rider Login Screen -->
<div id="rider-login-screen" class="screen">
    <div class="login-container">
        <div class="card">
            <h3>Rider Entry</h3>
            <input type="text" id="riderName" placeholder="Your Full Name">
            <button class="btn btn-main" onclick="startRiderShift()">START SHIFT</button>
            <button class="btn" style="background:none; color:grey;" onclick="showScreen('selection-screen')">Back</button>
        </div>
    </div>
</div>

<!-- 3. Admin Login Screen -->
<div id="admin-login-screen" class="screen">
    <div class="login-container">
        <div class="card">
            <h3>Admin Access</h3>
            <input type="password" id="adminPass" placeholder="Enter Password">
            <button class="btn btn-main" onclick="verifyAdmin()">LOGIN TO MAP</button>
            <button class="btn" style="background:none; color:grey;" onclick="showScreen('selection-screen')">Back</button>
        </div>
    </div>
</div>

<!-- 4. Rider Active Screen -->
<div id="rider-active-screen" class="screen">
    <div class="login-container">
        <div class="card pulse">
            <h2 id="activeRiderName" style="color:var(--red); margin:0;"></h2>
            <div class="status-box">TRACKING ACTIVE</div>
            <p style="font-size: 12px; color: #666; margin-top: 15px;">Keep this window open.<br>Your location is being shared with HQ.</p>
            <button class="btn btn-outline" onclick="stopShift()" style="border-color: #888; color: #888;">END SHIFT</button>
        </div>
    </div>
</div>

<!-- 5. Admin Panel Screen -->
<div id="admin-panel-screen" class="screen">
    <div id="sidebar">
        <strong style="color:var(--red)">LIVE RIDERS</strong>
        <div id="rider-list" style="margin-top:10px;">Waiting for GPS...</div>
    </div>
    <div id="map"></div>
</div>

<!-- Audio Hack for Background Geolocation -->
<audio id="stayAlive" loop playsinline><source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA== " type="audio/wav"></audio>

<script>
    // --- CONFIGURATION ---
    const firebaseConfig = { 
        // Replace with your actual Firebase URL
        databaseURL: "https://ovenx-tracking-default-rtdb.asia-southeast1.firebasedatabase.app/" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // OvenX Multan Branch Coordinates
    const SHOP_LOCATION = [30.216949, 71.470271]; 
    let map, markers = {};
    let watchID = null;

    // --- NAVIGATION ---
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        if(screenId === 'admin-panel-screen') initMap();
    }

    // --- ADMIN LOGIC ---
    function verifyAdmin() {
        const pass = document.getElementById('adminPass').value;
        if(pass === "asdasd@123") {
            showScreen('admin-panel-screen');
        } else {
            alert("Incorrect Password");
        }
    }

    function initMap() {
        if (map) return;
        map = L.map('map', { zoomControl: false }).setView(SHOP_LOCATION, 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        // Add HQ Marker
        L.marker(SHOP_LOCATION).addTo(map)
            .bindTooltip("OvenX Multan (HQ)", { permanent: true, direction: 'top' })
            .openTooltip();

        // Sync Riders from Firebase
        db.ref('riders').on('value', (snap) => {
            const data = snap.val();
            const listDiv = document.getElementById('rider-list');
            listDiv.innerHTML = '';

            for (let id in data) {
                const r = data[id];
                const isOnline = (Date.now() - r.lastSeen) < 60000; // Online if updated in last 60s
                
                if (isOnline) {
                    const label = `<b>${r.name}</b><br>${r.speed} km/h`;
                    if (markers[id]) {
                        markers[id].setLatLng([r.lat, r.lng]).setTooltipContent(label);
                    } else {
                        markers[id] = L.marker([r.lat, r.lng]).addTo(map)
                            .bindTooltip(label, { permanent: true, className: 'rider-tooltip' });
                    }

                    listDiv.innerHTML += `<div class="rider-row"><span><span class="online-dot">‚óè</span> ${r.name}</span> <b>${r.speed}km/h</b></div>`;
                } else {
                    if (markers[id]) {
                        map.removeLayer(markers[id]);
                        delete markers[id];
                    }
                }
            }
        });
    }

    // --- RIDER LOGIC ---
    function startRiderShift() {
        const name = document.getElementById('riderName').value.trim();
        if(!name) return alert("Please enter your name");

        document.getElementById('activeRiderName').innerText = name;
        document.getElementById('stayAlive').play(); // Prevents browser sleep
        showScreen('rider-active-screen');

        const riderID = name.replace(/\s+/g, '_').toLowerCase();

        watchID = navigator.geolocation.watchPosition((pos) => {
            const riderData = {
                name: name,
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                speed: Math.round((pos.coords.speed || 0) * 3.6),
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            };
            db.ref('riders/' + riderID).set(riderData);
        }, (err) => {
            console.error(err);
            alert("Please enable GPS/Location access");
        }, {
            enableHighAccuracy: true,
            maximumAge: 0
        });
    }

    function stopShift() {
        if(watchID) navigator.geolocation.clearWatch(watchID);
        location.reload(); 
    }

    // --- PWA & SERVICE WORKER ---
    const swCode = `
        self.addEventListener('install', e => self.skipWaiting());
        self.addEventListener('fetch', e => e.respondWith(fetch(e.request)));
    `;
    const swBlob = new Blob([swCode], {type: 'application/javascript'});
    const swURL = URL.createObjectURL(swBlob);
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register(swURL); }

    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installBanner').style.display = 'block';
    });

    function installPWA() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(() => {
                deferredPrompt = null;
                document.getElementById('installBanner').style.display = 'none';
            });
        }
    }
</script>

</body>
</html>
