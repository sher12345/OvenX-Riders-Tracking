<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oven X - Multan Command</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --red: #8b0000; --orange: #f37021; --dark: #1a1a1a; --white: #ffffff; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; height: 100%; background: #f4f4f4; overflow: hidden; }
        
        /* HEADER */
        header { 
            background: var(--red); color: white; padding: 12px 20px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; position: relative;
            border-bottom: 4px solid var(--orange);
        }
        header h1 { margin: 0; font-size: 20px; text-transform: uppercase; letter-spacing: 1px; }
        header span { color: var(--orange); }

        /* RIDER LOGIN */
        #rider-view { height: 100%; display: none; padding-top: 50px; }
        .card { background: white; margin: 0 auto; width: 85%; max-width: 400px; padding: 30px; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; }
        input { width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #eee; margin-bottom: 20px; font-size: 18px; box-sizing: border-box; outline: none; }
        .btn { background: var(--orange); color: white; padding: 18px; border-radius: 50px; border: none; font-weight: 900; width: 100%; cursor: pointer; box-shadow: 0 5px 0 #b34e12; text-transform: uppercase; transition: 0.2s; }
        .btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #b34e12; }

        /* ADMIN MAP VIEW */
        #admin-view { height: 100%; display: none; position: relative; }
        #map { height: 100%; width: 100%; z-index: 1; }

        /* MAP CONTROLS */
        .map-controls {
            position: absolute; bottom: 30px; right: 20px;
            display: flex; flex-direction: column; gap: 10px; z-index: 1000;
        }
        .control-btn {
            background: var(--white); border: none; width: 55px; height: 55px;
            border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .control-btn:active { background: #eee; }

        /* TOOLTIP / MARKER STYLE */
        .rider-tooltip {
            background: var(--red); color: white; border: 2px solid var(--orange);
            border-radius: 10px; padding: 5px 10px; font-weight: bold; text-align: center;
        }
        .rider-tooltip::before { border-top-color: var(--red); }
        
        .branch-marker {
            background: var(--orange); color: white; padding: 5px 10px;
            border-radius: 5px; font-weight: 900; border: 2px solid white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        /* STATUS */
        #status-bar { background: #25D366; color: white; text-align: center; padding: 8px; font-weight: bold; font-size: 13px; display: none; }
        #keepAliveVideo { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<header>
    <h1>OVEN <span>X</span> COMMAND</h1>
    <div id="active-count" style="font-size: 12px; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 20px; display: none;">0 RIDERS LIVE</div>
</header>
<div id="status-bar">üì° SIGNAL ACTIVE - DO NOT CLOSE</div>

<!-- RIDER INTERFACE -->
<div id="rider-view">
    <div class="card" id="login-box">
        <h3 style="color: var(--red);">RIDER DISPATCH</h3>
        <p style="font-size: 13px; color: #666;">Enter name to start delivery shift.</p>
        <input type="text" id="riderName" placeholder="Rider Name">
        <button class="btn" onclick="startRiderSession()">Start Delivery</button>
    </div>
    <div class="card" id="active-box" style="display:none;">
        <h2 id="hello-name" style="color: var(--red); margin: 0;"></h2>
        <div style="color: #25D366; font-weight: 900; font-size: 20px; margin: 15px 0;">ONLINE & TRACKING</div>
        <p style="color: #888; font-size: 14px;">Screen can be turned OFF now.<br>Keep phone in pocket.</p>
        <button class="btn" style="background:#555; box-shadow:0 5px 0 #222; margin-top:20px;" onclick="location.reload()">End Shift</button>
    </div>
</div>

<!-- ADMIN INTERFACE -->
<div id="admin-view">
    <div id="map"></div>
    <div class="map-controls">
        <button class="control-btn" title="Center Shop" onclick="centerShop()">üè™</button>
        <button class="control-btn" title="Center Riders" onclick="centerRiders()">üö¥</button>
    </div>
</div>

<video id="keepAliveVideo" playsinline muted loop>
    <source src="https://raw.githubusercontent.com/anars/blank-audio/master/250-milliseconds-of-silence.mp3" type="audio/mp3">
</video>

<script>
    // --- OVENX CONFIG ---
    const TOPIC = 'ovenx_multan_delivery_hq_01'; // Your secret channel
    const SHOP_COORD = [30.2248, 71.4883]; // OvenX Multan Branch (Bosan Road area)
    
    const params = new URLSearchParams(window.location.search);
    const isAdmin = params.get('admin') === 'true';

    let map, markers = {};
    let startTime = Date.now();

    if (isAdmin) {
        initAdminMap();
    } else {
        document.getElementById('rider-view').style.display = 'block';
    }

    // --- RIDER LOGIC ---
    async function startRiderSession() {
        const name = document.getElementById('riderName').value.trim();
        if (!name) return alert("Enter name!");

        document.getElementById('keepAliveVideo').play();
        if ('wakeLock' in navigator) { try { await navigator.wakeLock.request('screen'); } catch (e) {} }

        document.getElementById('login-box').style.display = 'none';
        document.getElementById('active-box').style.display = 'block';
        document.getElementById('status-bar').style.display = 'block';
        document.getElementById('hello-name').innerText = name.toUpperCase();

        const sessionStart = Date.now();

        navigator.geolocation.watchPosition((pos) => {
            const payload = {
                n: name,
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                spd: pos.coords.speed ? Math.round(pos.coords.speed * 3.6) : 0,
                start: sessionStart, // Send when they started
                upd: Date.now()
            };

            fetch(`https://ntfy.sh/${TOPIC}`, { method: 'POST', body: JSON.stringify(payload) });
        }, null, { enableHighAccuracy: true });
    }

    // --- ADMIN LOGIC ---
    function initAdminMap() {
        document.getElementById('admin-view').style.display = 'block';
        document.getElementById('active-count').style.display = 'block';

        // Professional Dark Mode Style Map
        map = L.map('map', { zoomControl: false }).setView(SHOP_COORD, 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: 'OvenX Multan'
        }).addTo(map);

        // Add Shop Marker
        L.marker(SHOP_COORD).addTo(map)
            .bindTooltip("OVENX MULTAN BRANCH", { permanent: true, direction: 'bottom', className: 'branch-marker' });

        const source = new EventSource(`https://ntfy.sh/${TOPIC}/sse`);
        source.onmessage = (e) => {
            try {
                const data = JSON.parse(JSON.parse(e.data).message);
                updateRiderMarker(data);
            } catch (err) {}
        };
    }

    function updateRiderMarker(data) {
        const now = Date.now();
        const durationMinutes = Math.floor((now - data.start) / 60000);
        
        let timeLabel = durationMinutes + "m out";
        if (durationMinutes > 60) {
            timeLabel = Math.floor(durationMinutes/60) + "h " + (durationMinutes%60) + "m out";
        }

        const infoText = `<b>${data.n}</b><br><small>${timeLabel}</small><br>${data.spd} km/h`;

        if (markers[data.n]) {
            markers[data.n].setLatLng([data.lat, data.lng]).setTooltipContent(infoText);
        } else {
            markers[data.n] = L.marker([data.lat, data.lng]).addTo(map)
                .bindTooltip(infoText, { permanent: true, direction: 'top', className: 'rider-tooltip' })
                .openTooltip();
        }
        
        // Update rider count
        const activeRiders = Object.keys(markers).length;
        document.getElementById('active-count').innerText = `${activeRiders} RIDERS LIVE`;
    }

    function centerShop() {
        map.flyTo(SHOP_COORD, 16);
    }

    function centerRiders() {
        const group = new L.featureGroup(Object.values(markers));
        if (group.getLayers().length > 0) {
            map.fitBounds(group.getBounds().pad(0.2));
        } else {
            centerShop();
        }
    }
</script>

</body>
</html>
