<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oven X Command & Dispatch</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --red: #8b0000; --orange: #f37021; --white: #ffffff; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; height: 100%; width: 100%; background: #f0f0f0; overflow: hidden; }
        header { background: var(--red); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--orange); z-index: 5000; }

        #admin-panel, #rider-app { display: none; height: calc(100vh - 55px); width: 100%; position: relative; }
        
        /* Rider App UI */
        #rider-app { background: white; padding: 20px; box-sizing: border-box; text-align: center; overflow-y: auto; display: none; }
        .card { background: #fff; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid #eee; margin-bottom: 20px; }
        .btn-main { background: var(--orange); color: white; padding: 18px; border-radius: 50px; border: none; font-weight: 900; width: 100%; cursor: pointer; font-size: 16px; box-shadow: 0 5px 0 #b34e12; margin-top: 15px; }
        .btn-check { background: #444; color: white; padding: 12px; border-radius: 10px; border: none; width: 100%; margin-top: 10px; font-weight: bold; font-size: 12px; }
        
        #sig-count { font-size: 40px; color: var(--orange); font-weight: 900; margin: 10px 0; }
        #error-msg { background: #ffebee; color: #c62828; padding: 10px; border-radius: 10px; font-size: 12px; margin-top: 15px; display: none; border: 1px solid #ef9a9a; }

        /* Admin Map UI */
        #map { height: 100%; width: 100%; }
        #sidebar { position: absolute; top: 10px; left: 10px; width: 240px; max-height: 60%; background: rgba(255,255,255,0.9); z-index: 1000; border-radius: 15px; padding: 10px; border: 1px solid var(--orange); overflow-y: auto; }
        .map-tools { position: absolute; bottom: 30px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .tool-btn { width: 50px; height: 50px; border-radius: 12px; background: white; border: 1px solid var(--orange); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="main-wrapper" style="height:100vh; display:flex; flex-direction:column;">
    <header>
        <h1 style="margin:0; font-size: 18px;">OVEN <span style="color:var(--orange)">X</span> HQ</h1>
        <div id="active-count" style="font-size:11px; font-weight:900;">SYSTEM ACTIVE</div>
    </header>

    <!-- RIDER VIEW -->
    <div id="rider-app">
        <div class="card" id="login-screen">
            <h2 style="color:var(--red); margin:0;">Rider Dispatch</h2>
            <p style="color:#777; font-size:13px;">Gulgasht Block A HQ</p>
            <input type="text" id="riderName" placeholder="Full Name" style="width:100%; padding:15px; border-radius:10px; border:1px solid #ddd; text-align:center; font-size:18px;">
            <button class="btn-check" onclick="requestPermission()">STEP 1: ENABLE GPS</button>
            <button class="btn-main" onclick="startShift()">STEP 2: START SHIFT</button>
            <div id="error-msg"></div>
        </div>

        <div class="card" id="active-screen" style="display:none;">
            <h2 id="display-name" style="color:var(--red); margin:0;"></h2>
            <div style="color:#2e7d32; font-weight:bold; margin:10px 0;">‚óè TRACKING ACTIVE</div>
            <div id="sig-count">0</div>
            <p style="margin:0; font-size:12px; color:#999;">Signals Sent to HQ</p>
            <button onclick="localStorage.clear(); location.reload();" style="margin-top:20px; background:none; border:none; color:#bbb; text-decoration:underline;">Logout</button>
        </div>
    </div>

    <!-- ADMIN VIEW -->
    <div id="admin-panel">
        <div id="sidebar">
            <h4 style="margin:0 0 10px 0; border-bottom:1px solid #ddd;">LIVE RIDERS</h4>
            <div id="rider-list"></div>
        </div>
        <div id="map"></div>
        <div class="map-tools">
            <button class="tool-btn" onclick="map.flyTo([30.216962, 71.470274], 18)">üè†</button>
        </div>
    </div>
</div>

<audio id="stayAlive" loop playsinline><source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA== " type="audio/wav"></audio>

<script>
    const SHOP = [30.216962, 71.470274];
    const TOPIC = 'ovenx_hq_dispatch_2026';
    let map, markers = {}, fleet = {}, count = 0;

    const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);

    window.onload = () => {
        if (!isMobile) {
            document.getElementById('admin-panel').style.display = 'block';
            initMap();
        } else {
            document.getElementById('rider-app').style.display = 'block';
            if(localStorage.getItem('ovenx_rider')) {
                document.getElementById('riderName').value = localStorage.getItem('ovenx_rider');
            }
        }
    };

    // Forces the phone to show the GPS prompt
    function requestPermission() {
        navigator.geolocation.getCurrentPosition(
            () => { alert("‚úÖ GPS Access Granted!"); document.getElementById('error-msg').style.display='none'; },
            (err) => { 
                document.getElementById('error-msg').innerText = "‚ùå GPS Error: Please go to App Settings and allow Location.";
                document.getElementById('error-msg').style.display = 'block';
            },
            { enableHighAccuracy: true }
        );
    }

    async function startShift() {
        const name = document.getElementById('riderName').value.trim();
        if(!name) return alert("Enter Name");
        
        localStorage.setItem('ovenx_rider', name);
        document.getElementById('stayAlive').play();

        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('active-screen').style.display = 'block';
        document.getElementById('display-name').innerText = name.toUpperCase();

        const start = Date.now();
        
        navigator.geolocation.watchPosition((pos) => {
            const data = { n: name, lt: pos.coords.latitude, lg: pos.coords.longitude, s: Math.round((pos.coords.speed || 0) * 3.6), start: start };
            fetch(`https://ntfy.sh/${TOPIC}`, { method: 'POST', body: JSON.stringify(data) })
            .then(() => { count++; document.getElementById('sig-count').innerText = count; });
        }, (err) => {
            console.log(err);
        }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
    }

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView(SHOP, 17);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker(SHOP).addTo(map).bindTooltip("HQ");
        
        const source = new EventSource(`https://ntfy.sh/${TOPIC}/sse`);
        source.onmessage = (e) => {
            const d = JSON.parse(JSON.parse(e.data).message);
            fleet[d.n] = d;
            const label = `<b>${d.n}</b><br>${d.s} km/h`;
            if (markers[d.n]) markers[d.n].setLatLng([d.lt, d.lg]).setTooltipContent(label);
            else markers[d.n] = L.marker([d.lt, d.lg]).addTo(map).bindTooltip(label, { permanent: true });
            
            const list = document.getElementById('rider-list');
            list.innerHTML = '';
            Object.keys(fleet).forEach(name => {
                const div = document.createElement('div');
                div.innerHTML = `<div style="padding:5px; border-bottom:1px solid #eee;"><b>${name}</b><br><small>${fleet[name].s} km/h</small></div>`;
                list.appendChild(div);
            });
        };
    }
</script>
</body>
</html>
