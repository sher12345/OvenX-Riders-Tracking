<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oven X - Gulgasht HQ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --red: #8b0000; --orange: #f37021; --white: #ffffff; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; height: 100%; background: #f4f4f4; overflow: hidden; }
        
        header { 
            background: var(--red); color: white; padding: 12px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 2000; position: relative;
            border-bottom: 4px solid var(--orange);
        }
        header h1 { margin: 0; font-size: 18px; text-transform: uppercase; }
        header span { color: var(--orange); }

        /* RIDER VIEW */
        #rider-view { height: 100%; display: none; padding-top: 40px; box-sizing: border-box; }
        .card { background: white; margin: 0 auto; width: 85%; max-width: 400px; padding: 30px; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; }
        input { width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #eee; margin-bottom: 20px; font-size: 18px; box-sizing: border-box; outline: none; text-align: center; }
        .btn { background: var(--orange); color: white; padding: 18px; border-radius: 50px; border: none; font-weight: 900; width: 100%; cursor: pointer; box-shadow: 0 5px 0 #b34e12; text-transform: uppercase; }

        /* ADMIN VIEW */
        #admin-view { height: 100%; display: none; position: relative; display: flex; flex-direction: column; }
        #map { flex-grow: 1; width: 100%; z-index: 1; }

        /* RIDER LIST PANEL (THE LOG) */
        #rider-list-panel {
            position: absolute; top: 10px; left: 10px; width: 220px;
            max-height: 60%; background: rgba(255, 255, 255, 0.95);
            z-index: 1000; border-radius: 15px; border-left: 5px solid var(--orange);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            padding: 10px; overflow-y: auto; display: none;
        }
        .rider-entry {
            background: #f9f9f9; padding: 8px; border-radius: 10px;
            margin-bottom: 8px; border: 1px solid #eee; font-size: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .rider-entry b { color: var(--red); font-size: 14px; }
        .find-btn { background: var(--orange); color: white; border: none; padding: 4px 8px; border-radius: 5px; cursor: pointer; font-size: 10px; font-weight: bold; }

        /* CONTROLS */
        .map-controls { position: absolute; bottom: 30px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        .control-btn { background: var(--white); border: none; width: 50px; height: 50px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .rider-tooltip { background: var(--red); color: white; border: 2px solid var(--orange); border-radius: 8px; padding: 5px 10px; font-weight: bold; text-align: center; }
        .hq-marker { background: var(--orange); color: white; padding: 4px 10px; border-radius: 6px; font-weight: 900; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 10px; }

        #keepAliveVideo { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<header>
    <h1>OVEN <span>X</span> GULGASHT HQ</h1>
    <div id="active-count" style="font-size: 11px; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 20px; display: none;">0 ACTIVE</div>
</header>

<!-- RIDER VIEW -->
<div id="rider-view">
    <div class="card" id="login-box">
        <h3 style="color: var(--red); margin: 0 0 15px 0;">RIDER DISPATCH</h3>
        <input type="text" id="riderName" placeholder="Rider Name">
        <button class="btn" onclick="startRiderSession()">Start Delivery</button>
    </div>
    <div class="card" id="active-box" style="display:none;">
        <h2 id="hello-name" style="color: var(--red);"></h2>
        <div style="color: #25D366; font-weight: 900; font-size: 22px; margin: 15px 0;">ONLINE</div>
        <button class="btn" style="background:#555; box-shadow:0 5px 0 #222;" onclick="location.reload()">End Shift</button>
    </div>
</div>

<!-- ADMIN VIEW -->
<div id="admin-view">
    <div id="rider-list-panel">
        <h4 style="margin: 0 0 10px 0; font-size: 14px; border-bottom: 2px solid var(--orange);">LIVE RIDERS</h4>
        <div id="rider-log-container">
            <p style="font-size: 10px; color: #999;">Waiting for riders...</p>
        </div>
    </div>
    <div id="map"></div>
    <div class="map-controls">
        <button class="control-btn" title="Shop" onclick="centerShop()">üè†</button>
        <button class="control-btn" title="Riders" onclick="centerRiders()">üö¥</button>
    </div>
</div>

<video id="keepAliveVideo" playsinline muted loop>
    <source src="https://raw.githubusercontent.com/anars/blank-audio/master/250-milliseconds-of-silence.mp3" type="audio/mp3">
</video>

<script>
    const SHOP_COORD = [30.223300, 71.496100]; 
    const TOPIC = 'ovenx_gulgasht_bridge_final';
    
    const params = new URLSearchParams(window.location.search);
    const isAdmin = params.get('admin') === 'true';

    let map, markers = {}, riderDataStore = {};

    if (isAdmin) {
        initAdminMap();
    } else {
        document.getElementById('rider-view').style.display = 'block';
    }

    async function startRiderSession() {
        const name = document.getElementById('riderName').value.trim();
        if (!name) return alert("Enter name!");
        document.getElementById('keepAliveVideo').play();
        if ('wakeLock' in navigator) { try { await navigator.wakeLock.request('screen'); } catch (e) {} }
        document.getElementById('login-box').style.display = 'none';
        document.getElementById('active-box').style.display = 'block';
        document.getElementById('hello-name').innerText = name.toUpperCase();

        const sessionStart = Date.now();
        navigator.geolocation.watchPosition((pos) => {
            const payload = {
                n: name,
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                spd: pos.coords.speed ? Math.round(pos.coords.speed * 3.6) : 0,
                start: sessionStart,
                upd: Date.now()
            };
            fetch(`https://ntfy.sh/${TOPIC}`, { method: 'POST', body: JSON.stringify(payload) });
        }, null, { enableHighAccuracy: true });
    }

    function initAdminMap() {
        document.getElementById('admin-view').style.display = 'block';
        document.getElementById('rider-list-panel').style.display = 'block';
        document.getElementById('active-count').style.display = 'block';

        map = L.map('map', { zoomControl: false }).setView(SHOP_COORD, 17);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

        L.marker(SHOP_COORD).addTo(map)
            .bindTooltip("OVENX GULGASHT HQ", { permanent: true, direction: 'bottom', className: 'hq-marker' });

        const source = new EventSource(`https://ntfy.sh/${TOPIC}/sse`);
        source.onmessage = (e) => {
            try {
                const data = JSON.parse(JSON.parse(e.data).message);
                updateRiderMarker(data);
            } catch (err) {}
        };
    }

    function updateRiderMarker(data) {
        // Save to Store
        riderDataStore[data.n] = data;
        
        const durationMin = Math.floor((Date.now() - data.start) / 60000);
        let timeLabel = durationMin + "m out";
        const infoText = `<b>${data.n}</b><br><small>${timeLabel}</small><br>${data.spd} km/h`;

        // Update Map Marker
        if (markers[data.n]) {
            markers[data.n].setLatLng([data.lat, data.lng]).setTooltipContent(infoText);
        } else {
            markers[data.n] = L.marker([data.lat, data.lng]).addTo(map)
                .bindTooltip(infoText, { permanent: true, direction: 'top', className: 'rider-tooltip' })
                .openTooltip();
        }

        renderRiderList();
        document.getElementById('active-count').innerText = `${Object.keys(markers).length} ACTIVE`;
    }

    function renderRiderList() {
        const container = document.getElementById('rider-log-container');
        container.innerHTML = '';
        
        for (let name in riderDataStore) {
            const r = riderDataStore[name];
            const durationMin = Math.floor((Date.now() - r.start) / 60000);
            
            const div = document.createElement('div');
            div.className = 'rider-entry';
            div.innerHTML = `
                <div>
                    <b>${r.n}</b><br>
                    ${durationMin}m out | ${r.spd} km/h
                </div>
                <button class="find-btn" onclick="focusOnRider('${r.n}')">FIND</button>
            `;
            container.appendChild(div);
        }
    }

    window.focusOnRider = function(name) {
        const r = riderDataStore[name];
        if (r) {
            map.flyTo([r.lat, r.lng], 18);
            markers[name].openTooltip();
        }
    }

    function centerShop() { map.flyTo(SHOP_COORD, 18); }
    function centerRiders() {
        const group = new L.featureGroup(Object.values(markers));
        if (group.getLayers().length > 0) map.fitBounds(group.getBounds().pad(0.3));
        else centerShop();
    }
</script>

</body>
</html>
